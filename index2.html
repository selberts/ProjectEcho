<!DOCTYPE html>
<html>
    <head>
        <title>Intramural Sports Scheduler</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.2.18.min.js"></script>
    </head>
    
    <body onload="createPref()">
        <style>
        form#team_info{
            display: inline-block;
            background: darkgray;
            border-style: solid;
            border-width: medium;
        }
        input{
            display: block;
        }
        </style>
        
        <form id="team_info" onsubmit="return sub()">
            Team submission form
            <input type="text" id="name" value="Team name" />
            <input type="button" id="addpref" value="Add pref" onclick="createPref()"/>
            <input type="submit" value="Submit">
        </form>
        <input type="button" value="Show Calendar" name="showCal" onclick="toggleCal()"/>
        <input type="button" value="Add mock event" name="addEvent" onclick="init()"/>
        <script type="text/javascript">

            Parse.initialize("r3WndIFb85R0lx1qhchN4nquvAQVeKVrkA3TBnpI", "Wui7puCTZpnTmA5ZLvJmlj5R044vAyDerOBXhYzq");
            /**
             * Callback function for form submission
             * Prepares name and pref_times, pref_days arrays for local storage
             * @returns {bool}  false signals page not to reload (ie, not sending info to webserve)
             */
            function sub(){
                /*  Uncomment to require 3 preferences 
               if(prefNum != 3) {
                   alert("Need to add three preferences");
                   return false;
               }
               */
               var pref_times = new Array();
               var pref_days = new Array();                
               var name = document.getElementById("name").value;
               
               var daySelects = document.getElementsByName("prefDay");
               var timeSelects = document.getElementsByName("prefTime");
                                             
               for(var i=0; i<daySelects.length; i++){ 
                   pref_times.push(timeSelects.item(i).value);
                   pref_days.push(daySelects.item(i).value);
               }
               
               /*
               // What to do with this information? Depends on our storage scheme
               var id = -1; // retrieved from local storage
               var team = {
				id: i +1, 
				team_name: name, 
				pref_times: pref_times,
				pref_days: pref_days
				};
                //<team stored locally>
               */
               var Teamdata = Parse.Object.extend("Teamdata");
               var teamdata = new Teamdata();
               teamdata.save({team_name: name , type:"team" , pref_days:pref_days , pref_times:pref_times}).then(function(object) {

                alert("Added successfully");
  
               });

               
               

               return false;
                
            }
            
            var prefNum = 0;
            var days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
            var times = [5,6,7,8];
            
            /**
             * Adds preference selects (time, day) to form
             * Limited to 3 preferences 
             * @returns {undefined}
             */
            function createPref(){
                var form = document.getElementById('team_info');
                var button = document.getElementById('addpref');
                
                
                var div = document.createElement("div");
                div.style.display = 'block';
                div.appendChild(createTimeSelect(prefNum));
                div.appendChild(createDaySelect(prefNum));
                form.insertBefore(div, button);
                
                prefNum++;
                if(prefNum == 3) form.removeChild(button);
            }
            
            /**
             * Creates a select with values for each of the time preference choices
             * @param {int} prefNum                         Preference number                      
             * @returns {createTimeSelect.select|Element}   Select created
             */
            function createTimeSelect(prefNum){
                var select = document.createElement("select");
                select.name = "prefTime";// + prefNum;
                
                for (var i = 0; i < times.length; i++){
                    var opt = document.createElement('option');
                    opt.value = times[i];
                    opt.innerHTML = times[i];
                    select.appendChild(opt);
                }
                
                return select;
            }
            
            /**
             * Creates a select with values for each of the day preference choices
             * @param {int} prefNum                         Preference number                      
             * @returns {createTimeSelect.select|Element}   Select created
             */
            function createDaySelect(prefNum){
                var select = document.createElement("select");
                select.name = "prefDay";// + prefNum;
                
                for (var i = 0; i < days.length; i++){
                    var opt = document.createElement('option');
                    opt.value = days[i];
                    opt.innerHTML = days[i];
                    select.appendChild(opt);
                }
                
                return select;
            }
            
        </script>
        
        <script type="text/javascript">
	// This javascript will have to be server side in the final product,
	// since it gives away the information needed to access the calendar
	// Except for refreshing the calendar, it works independent of the page
	
	var calDisplay = false;
	// Game parameters; presumably handed by scheduling function
	var game = "Game";
	var loc = "Location";
	var desc = "Description";
	var start = "2014-05-18";
	var end = "2014-05-19";
	
	// Note that I'm currently hosting the calendar with my email address;
	// We can change this if need be
	var calendarID = "lukeolney@gmail.com";
	
	function toggleCal(){
	    var cal = document.getElementById("calendar");
	    
	    if(calDisplay) {
	        calDisplay = false;
	        cal.style.display = "none";
	    }
	    else{
	        calDisplay = true;
	        cal.style.display = "block";
	    }
	}
	/*
	* Autheticates our application for accessing Google API
	* More information:
	* http://googleappsdeveloper.blogspot.com/2011/12/using-new-js-library-to-unlock-power-of.html
	*/
	function init() {
	     if(calDisplay == false) return false;
	     
	     var clientId = '480075007100.apps.googleusercontent.com';
	     var scopes = 'https://www.googleapis.com/auth/calendar';
	
	      
	      // Load the API key from the Developer Console
	      gapi.client.setApiKey('AIzaSyDWMoEWCsh4giDWiBKZSVyzIytQBc73gu4');
	      checkAuth();
	       
	      function checkAuth() {
	        gapi.auth.authorize({client_id: clientId, scope: scopes, immediate: true}, handleAuth);
	      }
		
	      function handleAuth(authResult) {
	      	if (authResult && !authResult.error) {
	      		makeApiCall(game, loc, desc, start, end);
	      	}
	      	else doAuth();
	      }
	      function doAuth() {
	        // Get authorization to use private data
	        
	        gapi.auth.authorize({client_id: clientId, scope: scopes, immediate: false}, makeApiCall(game, loc, desc, start, end));
	        return false;
	      }
	     
	 }
	 
	  /*
	   * Inserts an event into the calendar
	   * @param game    Title of the game (displaces as summary in calendar interface)
	   * @param loc     Location
	   * @param desc    Description
	   * @param start   Start time
	   * @param end     End time
	   */
	  function makeApiCall(game, loc, desc, start, end){
	    
	      // Format for the event
	      // Note: can add more parameters; documentation here: 
	      // https://developers.google.com/google-apps/calendar/v3/reference/events/insert
	      var event = {
	              "summary": game,
	              "location": loc,
	              "description": desc,
	              "end": {
	                  "date": end       // use dateTime instead to include time
	              },
	              "start": {
	                  "date": start
	              }
	          };
	  
	    gapi.client.load('calendar', 'v3', function() {
	        var request = gapi.client.calendar.events.insert({
	            'calendarId': calendarID,
	            'resource': event
	          });
	
	      request.execute(function(resp) {
	        if (resp.id){
		   	 console.log("Event added");
	                 // Refresh the calendar
	                 document.getElementById("calendar").innerHTML =
	                         '<iframe src="https://www.google.com/calendar/embed?src=lukeolney%40gmail.com&ctz=America/Chicago" style="border: 0" width="800" height="600" frameborder="0" scrolling="no"></iframe>';
		   }
		   else{
		   	console.log(resp.message);
		   }
	      });
	    });
	  }
  
    </script>
    
    <script src="https://apis.google.com/js/client.js?onload=init"></script>
    <div id="calendar" style="display: none">
        <iframe src="https://www.google.com/calendar/embed?src=lukeolney%40gmail.com&ctz=America/Chicago"
                style="border: 0" width="800" height="600" frameborder="0" scrolling="no"></iframe>
    </div>
    </body>
</html>
